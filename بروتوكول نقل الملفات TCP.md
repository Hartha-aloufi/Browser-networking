# بروتوكول التحكم بالنقل TCP





البروتوكول هو مجوعة من القواعد المعروفة مسبقاً والتي تحدد كيفية تبادل البيانات بين الأجهزة على الشبكة بغض النظر عن أي اختلافات بينها.

 وهذه القواعد تشمل كيفية بدء التبادل وشكل البيانات وتنسيقها وحجمها وأيضاً كيفية التعامل مع الحالات الكثيرة قبل وبعد وأثناء التبادل كالتأكد من وصولها وأمانها وما العمل في حال فقدان جزء منها وغير ذلك.   

لكن ماذا عن صديقنا لهذا اليوم، بروتوكول التحكم بالنقل TCP أو (Transmission Control Protocol): هو بروتوكول يوفر  اتصالاً موثوقاً لنقل البيانات بين جهازين على الشبكة. أي أنه يضمن وصول البيانات من المرسل الى المستقبل، ويضمن أيضاً ايصالها بالترتيب الصحيح. وهو يفعل هذا كله بالاعتماد على قناة اتصال غير موثوقة يوفرها بروتوكول آخر هو بروتوكول الشابكة (Internet Protocol - IP).

يأخذ بروتوكول التحكم بالنقل على عاتقه الكثير من تعقيدات التواصل في الشبكة ويخفيها عن تطبيقاتنا: كإعادة ارسال البيانات الضائعة والتحكم بالاحتقان(Congestion control) وتجنبه وسلامة البيانات وغير ذلك. فبروتوكول التحكم بالنقل حُسٍّن وطُوِّرَ بشكل أساسي من أجل الدقة وليس السرعة، وهذا الأمر يفتح علينا مجموعة من التحديات عندما نأتي الى تحسين أداء الويب.

لم تحدد معايير الـ HTTP بروتوكول التحكم بالنقل TCP كالبروتوكول النقل الوحيد ولا تلزم به، فيمكننا استخدام الـ UDP أو أي بروتوكول آخر لإيصال الـ HTTP، لكن عملياً، جميع حركات الـ HTTP عبر الشابكة تتم من خلال الـ TCP وذلك للمزايا الرائعة التي يقدمها.



### التصافح الثلاثي

جميع الاتصالات التي تتم باستخدام الـ TCP تبدأ بتصافح ثلاثي، حيث يجب على طرفي الاتصال -الخادم والعميل- الاتفاق على مجموعة من الأرقام والمتغيرات الخاصة بالاتصال قبل بدئه.



##### SYN

يقوم العميل باختيار رقم متسلسل "x" بشكل عشوائي، ثم يرسل حزمة SYN من كلمة (Syncronization) الى الخادم، ويمكن أيضاً أن تضمن الحزمة خيارات متغيرات أٌخرى تخص الـ TCP.



##### SYN ACK

يقوم الخادم بزيادة "x" ك ACK من كلمة (Acknowledgment) والتي تعني اشعار استلام، ثم يختار رقماً متسلسلاً خاص به "Y"، ويضيف ما يريد من خيارات ومتغيرات تخص الـ TCP ثم يرسل الرد.



##### ACK

يقوم العميل بزيادة الرقمين المتسلسلين "x" و "y" ثم ينهي التصافح الثلاثي بإرسال آخِر إشعار استلام الى الخادم.



وحين تكتمل عملية التصافح الثلاثي، يمكن للخادم والعميل بدء تبادل البيانات. فيستطيع العميل ارسال حزمة بياناتٍ مباشرةً بعد ارسال الإشعارـ ويجب على الخادم الانتظار حتى يستلم حزمة الإشعار قبل أن يتمكن من ارسال أي بيانات للعميل. وهذه التهيئة تتم قبل كل اتصال TCP، وهذا يفرض تكلفة حتمية عند بدء أي اتصال تؤثر على أداء جميع التطبيقات التي تستخدم بروتوكول التحكم بالنقل TCP. 

على سبيل المثال، لو كان العميل في مدينة نيويورك والخادم في مدينة لندن، وقمنا ببدء اتصال TCP جديد باستخدام خط الياف ضوئيّة، فستستغرق عملية التصافح الثلاثي 58 جزء من الثانية، وهنا لم يلعب عرض النطاق أي دور، فالمحدد هنا هو زمن الوصول بين الخادم والعميل والذي يمثل أغلبه زمن الارسال بين نيويورك ولندن.

التأخير المفروض من قبل عملية التصافح الثلاثي تجعل من عملية انشاء اتصال TCP جديد أمراً مكلفاً وتعتبر أحد الأسباب الرئيسية في كون ميزة إعادة استخدام الاتصال تحسين حاسماً في جميع التطبيقات التي تعمل باستخدام بروتوكول التحكم بالنقل TCP.

### التحكم بالتدفق

التحكم بالتدفق هي آلية لمنع المرسل من إغراق المستقبل بكمية بيانات هو غير قادر على مجاراته فيها ومعالجتها. فقد يكون المستقبل مشغولاً أو أنه قد خصص مساحة  بفر (buffer) ثابتة. ولمعالجة هذا، يقوم كلا طرفي الاتصال بالإعلان عن نافذة الاستقبال الخاصة بهما (Recive window) ويشار اليها ب rwnd والتي تمثل المساحة المتاحة من البفر لحفظ البيانات فيها مؤقتاً. عندما يتم تجهيز الاتصال، يقوم كلا الطرفين بتهيئة حجم نافذة الاستقبال باستخدام القيم الافتراضية لنظام التشغيل الخاص بكل منهما.

وفي حال عدم قدرة أحد الطرفين على الاستمرار على نفس النسق، يقوم بتقليل حجم النافذة ويعلن عن ذلك للطرف الآخر. فإذا وصل حجم النافذة الى الصفر، فذلك يعني أن المستقبل لا يمكنه استقبال المزيد وعلى المرسل الانتظار حتى افراغ البفر.

##### توسيع نافذة الاستقبال

تم تخصيص 16-بت لنافذة الاستقبال في مواصفات الـ TCP، وذلك يعني أن الحد الأعلى هو 65535-بايت، ولكن لاحقاً، غدى هذا الحد غير كافٍ للحصول على الأداء الأفضل، خاصةً في الشبكات التي تمتلك عرض نطاق عالٍ. ولحل هذه المشكلة تم طرح ميزة توسيع نافذة (window scaling) والتي تسمح لنا بزيادة الحد الأعلى للنافذة 1-جيجا. هذه الميزة مفعّلة افتراضياً على جميع المنصات الرئيسية. وهي نقطة بداية جدية عند البحث عن السبب وراء قصور الشبكة عن استغلال كامل عرض النطاق.

### البداية البطيئة 









 