# بروتوكول التحكم بالنقل TCP





البروتوكول هو مجوعة من القواعد المتفق عليها والتي تحدد كيفية تبادل البيانات بين الأجهزة على الشبكة بغض النظر عن الاختلافات بينها.

 هذه القواعد تشمل كيفية بدء التبادل وشكل البيانات وتنسيقها وحجمها وأيضاً كيفية التعامل مع الحالات الكثيرة قبل وبعد وأثناء التبادل كالتأكد من وصولها وأمانها وما العمل في حال فقدان جزء منها وغير ذلك.   

لكن ماذا عن صديقنا لهذا اليوم، بروتوكول التحكم بالنقل TCP أو (Transmission Control Protocol): هو بروتوكول يوفر  اتصالاً موثوقاً لنقل البيانات بين جهازين على الشبكة. أي أنه يضمن وصول البيانات من المرسل الى المستقبل، ويضمن أيضاً ايصالها بالترتيب الصحيح. وهو يفعل هذا كله بالاعتماد على قناة اتصال غير موثوقة يوفرها بروتوكول آخر هو بروتوكول الشابكة (Internet Protocol - IP).

يأخذ بروتوكول التحكم بالنقل على عاتقه الكثير من تعقيدات التواصل في الشبكة ويخفيها عن تطبيقاتنا: كإعادة ارسال البيانات الضائعة والتحكم بالاحتقان(Congestion control) وتجنبه وسلامة البيانات وغير ذلك. بروتوكول التحكم بالنقل حُسٍّن وطُوِّرَ بشكل أساسي من أجل الدقة وليس السرعة، وهذا يعرضنا لمجموعة من التحديات عند تحسين أداء الويب.

لم تحدد معايير الـ HTTP بروتوكول التحكم بالنقل TCP كبروتوكول النقل الوحيد ولا تلزم به، فيمكننا استخدام الـ UDP أو أي بروتوكول آخر لإيصال الـ HTTP، لكن عملياً، جميع حركات الـ HTTP عبر الشابكة تتم من خلال الـ TCP وذلك للمزايا الرائعة التي يقدمها.



### التصافح الثلاثي

وهي عملية لتهيئة الاتصال واعداده قبل بدء نقل البيانات, فجميع الاتصالات التي تتم باستخدام الـ TCP تبدأ بتصافح ثلاثي، حيث يجب على طرفي الاتصال -الخادم والعميل- الاتفاق على مجموعة من الأرقام والمتغيرات الضرورية والتي تخص الاتصال قبل بدئه.



##### SYN

يقوم العميل باختيار رقم متسلسل "x" بشكل عشوائي، ثم يرسل حزمة SYN من كلمة (Syncronization) الى الخادم، ويمكن أيضاً أن تضمن الحزمة خيارات متغيرات أٌخرى تخص الـ TCP.



##### SYN ACK

يقوم الخادم بزيادة "x" ك ACK من كلمة (Acknowledgment) والتي تعني اشعار استلام، ثم يختار رقماً متسلسلاً خاص به "Y"، ويضيف ما يريد من خيارات ومتغيرات تخص الـ TCP ثم يرسل الرد.



##### ACK

يقوم العميل بزيادة الرقمين المتسلسلين "x" و "y" ثم ينهي التصافح الثلاثي بإرسال آخِر إشعار استلام الى الخادم.



وحين تكتمل عملية التصافح الثلاثي، يمكن للخادم والعميل بدء تبادل البيانات. فيستطيع العميل ارسال حزمة بياناتٍ مباشرةً بعد ارسال الإشعارـ ويجب على الخادم الانتظار حتى يستلم حزمة الإشعار قبل أن يتمكن من ارسال أي بيانات للعميل. وهذه التهيئة تتم قبل كل اتصال TCP، وهذا يفرض تكلفة حتمية عند بدء أي اتصال تؤثر على أداء جميع التطبيقات التي تستخدم بروتوكول التحكم بالنقل TCP. 

على سبيل المثال، لو كان العميل في مدينة نيويورك والخادم في مدينة لندن، وقمنا ببدء اتصال TCP جديد باستخدام خط الياف ضوئيّة، فستستغرق عملية التصافح الثلاثي 58 جزء من الثانية، وهنا لم يلعب عرض النطاق أي دور، فالمحدد هنا هو زمن الوصول بين الخادم والعميل والذي يمثل أغلبه زمن الارسال بين نيويورك ولندن.

التأخير المفروض من قبل عملية التصافح الثلاثي تجعل من عملية انشاء اتصال TCP جديد أمراً مكلفاً وتعتبر أحد الأسباب الرئيسية في كون ميزة إعادة استخدام الاتصال تحسين حاسماً في جميع التطبيقات التي تعمل باستخدام بروتوكول التحكم بالنقل TCP.

### التحكم بالتدفق

التحكم بالتدفق هي آلية لمنع المرسل من إغراق المستقبل بكمية بيانات هو غير قادر على مجاراته فيها ومعالجتها. فقد يكون المستقبل مشغولاً أو أنه قد خصص مساحة  بفر (buffer) ثابتة. ولمعالجة هذا، يقوم كلا طرفي الاتصال بالإعلان عن نافذة الاستقبال الخاصة بهما (Recive window) ويشار اليها ب rwnd والتي تمثل المساحة المتاحة من البفر لحفظ البيانات فيها مؤقتاً. عندما يتم تجهيز الاتصال، يقوم كلا الطرفين بتهيئة حجم نافذة الاستقبال باستخدام القيم الافتراضية لنظام التشغيل الخاص بكل منهما.

وفي حال عدم قدرة أحد الطرفين على الاستمرار على نفس النسق، يقوم بتقليل حجم النافذة ويعلن عن ذلك للطرف الآخر. فإذا وصل حجم النافذة الى الصفر، فذلك يعني أن المستقبل لا يمكنه استقبال المزيد وعلى المرسل الانتظار حتى افراغ البفر.

##### توسيع نافذة الاستقبال

تم تخصيص 16-بت لنافذة الاستقبال في مواصفات الـ TCP، وذلك يعني أن الحد الأعلى هو 65535-بايت، ولكن لاحقاً، غدى هذا الحد غير كافٍ للحصول على الأداء الأفضل، خاصةً في الشبكات التي تمتلك عرض نطاق عالٍ. ولحل هذه المشكلة تم طرح ميزة توسيع نافذة (window scaling) والتي تسمح لنا بزيادة الحد الأعلى للنافذة 1-جيجا. هذه الميزة مفعّلة افتراضياً على جميع المنصات الرئيسية. وهي نقطة بداية جدية عند البحث عن السبب وراء قصور الشبكة عن استغلال كامل عرض النطاق.

### البداية ببطء 

على الرغم من أن التحكم بالتدفق ناجح في منع المرسل من إغراق المستقبل, الا أنه لا يمنع أيً من الطرفين من اغراق الشبكة بينهما. وذلك لعدم معرفتهما بكم النطاق المتاح عند بدء اتصال جديد. ولذلك فإنا بحاجة الى آلية لتخمين المتاح منه  وأيضاً لضبط سرعة الاتصال وجعله يتكييف مع حالة الشبكة التي تتغير باستمرار. 

ولنظرب مثالاً على ذلك, تخيَّل أنك متصل بشبكة المنزل وتشاهد أحد المرئيات من على أحد الخوادم والذي يسعى الى إشباع كامل المتاح من نطاق التحميل ليوصل لك أفضل جودةٍ للمرئية, ثم ظهر مستخدم آخر على نفس شبكتك وبدأ بتحميل ملف كبير. وهنا فجأةً قل المتاح من نطاق التحميل لاتصالك بدرجة كبيرة, فيجب على الخادم فوراً أن يتكييف مع هذا التغير, عدا ذلك, اذا استمر بنفس المستوى ستتكوم البيانات في احدى نقاط الشبكة ثم تلقى. وهذا استخدام غير ناجع للشبكة.



الطريقة الوحيدة لتخمين المتاح من النطاق هي بقياسها عند تبادل البيانات! وهذا بالتحديد ما تفعله خوارزمية البداية البطيئة. حيث يقوم الخادم بتهيئة متغير باسم (cwnd) -والذي بمعنا حجم نافذة الاحتقان- لكل اتصال TCP بقيمة افتراضية ياخذها من نظام التشغيل وهي (initcwnd) على 

نظام التشغيل لينكس. 



*حجم نافذة الاحتقان*:

هو حدٌ يتم ضبطه من جهة المرسل يحدد كمية البيانات البينية (التي ارسلت ولم يتم بعد تاكيد استلامها) التي يمكنه امتلاكها قبل وصول اشعار استلام (Acknowledgment - ACK) من المستقبل.



لاحقاً, تم اضافة تعديل وهو: كم البيانات البينية المسموح بها هو القيمة الأصغر بين المتغيرين cwnd و rwnd. وهذا يطرح سؤالاً مهماً وهو كيف يحدد المرسل والمستقبل أفضل قيمٍ لهذين المتغيريين؟ 

الحل هو أن نبدأ ببطئ بقيم صغيرة ثم نقوم بزيادتها تدريجياً مع وصول إشعارات الاستلام. في الأصل كانت القيمة الابتدائية هي 1 ثم لاحقاً حُدثت الى 4 ومؤخراً في عام 2013 تم رفعها الى 10.

وذلك يعني أن المرسل يستطيع ارسال اربعة اقطاع بيانية (TCP Segment) وبعدها عليه التوقف الى حين وصول تاكيد الاستلام. وعند استلام التأكيد تقوم خوارزمية البداية ببطء بزيادة متغير نافذة الاحتقان cwnd بمقدار 1 لكل تأكيد استلام. 



معرفة تفاصيل هذه الخوارزمية مهم جداً, وذلك لأنها تطبق على كل اتصالات بروتوكول النقل الـ TCP والذي هو عماد بروتوكول HTTP اساس تطبيقات الويب. وهذا يقودنا لاستنتاج مهم, وهو أننا لا نستطيع أن نستخدم كامل قدرة الشبكة مباشرةً, بل نحتاج لبعض الوقت حتى يتم الوصول الى القيمة الأفضل لمتغير نافذة الاحتقان. هذا لا يعد مشكلة للاتصالات الطويلة عند نقل البيانات الكبيرة كتحميل الملفات وبث المرئيات حيث أن عدد دورات النقل اللازمة للوصول الى القيم للمتغيرات لا تعد شيئاً الى عدد دورات الاتصال كله. وكلنه يعد مشكلة كبيرة للاتصالات القصيرة والسريعة والتي تشكل اغلب اتصالات الـ HTTP, حيث أنها تنتهي قبل أن تصل الى القيم المثلى لنافذة الاحتقان. وهذا يشكل 



 