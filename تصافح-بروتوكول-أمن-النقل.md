



### موقع بروتوكول أمن النقل

تم تصميم بروتوكول أمن طبقة النقل الـ TLS حيثُ يأتي بين طبقة التطبيق وطبقة النقل وبذلك فإن بروتوكولات طبقة النقل لا تتأثر بالتشفير وبما يفعله الـ TLS فهو أمر لا يعنيها. لذلك لدينا بروتوكول HTTPS وليس لدينا TLSS أو UDPS على سبيل المثال.



![TLS-Handshake](/home/hartha/Desktop/TLS-Handshake.svg)











### تصافح الـ TLS 

قبل فتح قناة اتصال آمنة بين طرفين, يجب أولاً أن يتفقا على عدّة أُمورٍ بينهما, وهذا دائماً هدف التصافح, وهو التهئية والإعداد للإتصال. الا أن هذا مختلف قليلاً في تصافح الـ TLS, فأغلب الأُمور المهمة تتم خلال التصافح. فيجب على الطرفين الاتفاق على إصدار الـ TLS وخوارزمية التشفير (ciphersuite) وعلى المفاتيح التي ستستخدم في التشفير. وأيضاً يعطي بروتوكول الـ TLS لكلا طرفي الاتصال إمكانية التحقق من هويّة الآخر(الإستيثاق) كجزء من عملية التصافح. للأسف فكل واحدةٍ مما سبق تتطلب جولة كاملة(Round Trip), وهذا يزيد زمن الوصول لكل الإتصالات التي تستخدم الـ TLS.



![تصافح-بروتوكول-أمن-النقل](/home/hartha/Desktop/تصافح-بروتوكول-أمن-النقل.svg)

**0 ج.ث:**

 يعمل بروتكول الـ TLS فوق بروتوكول النقل TCP, لذا فيجب في البداية اكمال التصافح الثلاثي الخاص بالـTCP. والذي ياخذ دورة كاملة.



**56 ج.ث:**

يرسل العميل اول رسالة تخص تصافح الـTLS وتدعى ب "ترحيب العميل" (Client Hello) وتتضمن قائمة باصدارات الـ TLS التي يدعهما, وقائمة أٌخرى بحزم التشفير(Ciphersuite) المدعومة وغيرها. 



**84 ج.ث:**

يقوم الخادم باختيار اصدار الـTLS وحزمة التشفير التي يرغب بها من القوائم التي ارسلها العميل ومن ثم يرفق شهادة توثيقه(Certificate) ويرسل الرد الى العميل. إختيارياً, يمكن للخادم طلب شهادة توثيقٍ من العميل ومعاملات أُخرى تخص اضافات ما للTLS.



**112 ج.ث:**

على فرض أن كلا الطرفين استطاعا التوفيق فيما بينهما بخصوص الإصدار وحزمة التشفير, وأن العميل قَبِلَ الشهادة التي ارسلها الخادم, عندها سيبدأ العميل بتهيئة مفتاح التشفير المتناظر(Symmetric Key) باستخدام خوارزمية ديفي-هيلمن أو خوارزيمة RSA, وهذا يعرف بعملية تبادل المفتاح (Key Exchange).



**140 ج.ث:**

يقوم الخادم  بمعالجة المعاملات الخاصة بعملية تبادل المفتاح المتناظر والتأكد من سلامة الرسالة من خلال التحقق من لابد الرسالة (MAC). ثم يرسل رسالة إنهاء (Finish Message) مشفرة الى العميل.



**168 ج.ث**:

يقوم العميل بفك شيفرة الرسالة بستخدام المفتاح المتناظر ثم التأكد من سلامة الرسالة من خلال لابد الرسالة (MAC). فاذا مر على كل شيءٍ على ما يرام, عندها تكون قناة الـTLS جاهزة ويمكن البدء بتبادل بيانات التطبيق.



كما يتضح, يحتاج الـ TLS الى جولتين كاملتين لإتمام التصافح! هذا يعني أن كافة الاتصالات الآمنة التي تستخدم الـTLS ستسبق بجولتين كاملتين قبل بدء الاتصال الفعلي! وهذا أمر سيء جداً, لكن لحسن الحظ فإن لدينا تحسينات على عملية التصافح تضمن تقليص الجولتين الى جولة واحدة(RTT-1) فقط:



##### البداية الكاذبة (False Start): 

هي إضافة TLS تسمح لطرفي الاتصال ببدء ارسال بيانات التطبيق قبل إنتهاء علمية التصافح, وذلك بعد أن يرسل الخادم رسالة الإنهاء. وبذلك تقلص الجولتين الى جولة واحدة.



##### استئناف الجلسة (Session Resumption):

اذا كان هناك اتصال سابق بين الخادم والعميل عندها يمكن استخدام المفتاح المتناظر القديم والمتبادل مسبقاً دون الحاجة الى تكرار عملية توليده وتبادله, وهذا أيضاً يقلص عدد الجولات الى جولة واحدة.



هذان التحسينان يضمنان تقليص الجولتين الى جولة واحدة للاتصالات الجديدة والمتكررة في اصدار TLS 1.2. أما في اصدار TLS 1.3 فقد تم تحسين التصميم بحيث لا يستهلك تهيئة TLS للاتصالات المتكررة أي جولة عملياً. أي 0-RTT.



نستنتج أن تصافح الـTLS غرضه تهيئه الطرفين لبدء تشفير وتأمين الاتصال. فيتم فيه:

1.  الاتفاق على تفاصيل التشفير: الاصدار, حزمة التشفير ومعاملات أُخرى تخص اضافات على الـTLS.
2.  توليد وتبادل مفاتيح التشفير.
3.  استيثاق طرفي الاتصال من بعضهمها. خاصة ان يستوثق العميل من هوية الخادم.



















