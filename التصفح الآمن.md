# التصفح الآمن



تحدثنا فيما سبق عن بروتوكولي النقل الـ TCP والـ UDP, ودائماً ما يقترن النقل والارسال بالسطو والاعترراض والتزييف, ويقترن أيضاً بالحماية والتشفير وتأمين ما ينقل. 

تقتصر مهمة بروتوكولات النقل فقط على نقل وايصال البيانات ولا تُعنى ابداً بتأمين المنقول أو حمايته.  فهذه مهمة إضافية توكل الى بروتوكول آخر وهو بروتوكول "أمن طبقة النقل" (Transport Layer Security).



تم البدء بتطوير بروتوكول الـ Secure Socket Layer- SSL- في شركة Netscape لتمكين العمليات التجارية على الشابكة (التجارة الالكترونية) والتي تتطلب تشفير وحماية معلومات العملاء والاستيثاق منهم (Authentication).  ضل الاصدار الاول من الـ SLL داخلياً في شركة نتسكيب وذلك لظهور مشاكل عدّة به الى أن ظهر الاصدار الثاني بسرعة لحل تلك المشاكل ومن ثم الاصدار الثالث. كان هناك شركات ومجموعات أُخرى تعمل أيضاً على إيجاد حلول لتشفير وتأمين الشابكة, كلٌ يعمل لوحده, مثل شركة مايكروسوفت وغيرها. الى أن تم توحيد العمل بين نتسكيب ومايكروسوفت ليخرج لنا بروتوكول أمن طبقة النقل -الـ  TLS- باصداره الاول سنة 1999. وفي الحقيقة لم يكن الـ TLS إلا بروتوكول الـ SLL الإصدار الثالث مع بعض التحسينات. أي SSL v3.1.



يتم عادةً استخدام مصطلحَيّ الـ SSL والـ TLS للاشارة الى نفس الشيء, لكنهما عملياً مختلفان, بالطبع ليسا بروتوكولين مختلفين تماماً, لكنهما يشيران الى إصدارات مختلفة لبروتوكولٍ واحد.



استمرت التحديثات على بروتوكول الـ TLS لحل بعض المشاكل المكتشفة ولتحسين قدراته فظهر TLS 1.1 سنة 2006 ثم TLS 1.2 سنة 2008 ثم حديثاً TLS 1.3 سنة 2018.



### التشفير والإستيثاق وسلامة البيانات

صُمِّم بروتوكول أمن النقل الـ TLS ليقدم 3 خدمات للتطبيقات التي تستخدمه: التشفير والإستيثاق وسلامة البيانات. عملياً, لا يلزم استخدام هذه الثلاث في كل الحالات, لكن تطبيق الويب الآمن يُسخِرُها كلَها.

#### التشفير:

**هي آلية لتَعمِية ما يرسل بين طرفين. وقد كانت العرب تستخدم مصطلح التَعمية واستخراج المُعَمَّى بدل ما يعرف اليوم بالتشفير وفكه.**



ويمكن أن نقول أيضاً أن التشفير هو تحويل الرسالة من شكلها المفهوم والمقروء الى شكلٍ عشوائي غير مفهوم. وبعد ارسالها الى المستقبل, يقوم هو بدوره بفك تشفير الرسالة وإعادتها الى شكلها الأصلي. حيث يتفق المرسل والمستقبل مسبقاً على **مفتاح التشفير** الذي يستخدم في التشفير وفك تشفير الرسالة.



تُقَسَّم طرق التشفير بالنظر الى نوع المفاتح الى:

##### التشفير بالمفتاح المتناظر (السري): 

حيث يعتمد التشفير على مفتاح واحد معروف لدى طرفي الاتصال للتشفير وفك التشفير, ويجب أن يبقى هذه المفتاح سرياً ومخبئاً لا تتم مشاركته. ويعرف بـ Symmetric Key Cryptography. 

يستخدم بروتوكول أمن الشبكة خوارزمية Diffie-Hellman لتبادل المفتاح المتناظر, والتي تمكّن طرفي الاتصال -الخادم والعميل- من تبادل مفتاح التشفير من غير أن يُرسل بشكل صريح عبر الشبكة, وذلك من خلال تبادل بعض المتغيرات ومن ثم يضيف كل طرف متغيراته السريّة ويطبق بعض العمليات الرياضية كلٌ على حدى لتوليد المفتاح النهائي. وبذلك لا يمكن لأي طرف ثالث يعترض الاتصال أن يعرف قيمة المفتاح.



##### التشفير بالمفتاح الغير متناظر (العلني):

 حيث يعتمد التشفير على مفتاحين مختلفين لكنها يُكَمِّلان بعضيهما. فما يُشفر بالمفتاح الأول يفك تشفيره بالمفتاح الثاني والعكس صحيح. يتم اختيار أحد هذه المفاتيح ليكون **سرياً** لا تتم مشاركته, ويكون المفتاح الثاني علني ويمكن لأي شخص الوصول اليه واستخدمه.



![](/home/hartha/workspace/Personal-Blog/public/static/images/blogs/التصافح-الامن/المفتاح-العام.png)



هذه الفكرة ذكية جداً وتتيح امكانية تشفير الرسائل بين اي طرفين بسهول, فببساطة, إذا أردت ارسال رسالة مشفرة لي, قم بتشفير الرسال بفتاحي العلني وارسل الرسالة الي, وانا سأقوم بفك تشفيرها باستخدام مفتاحي السري الوحيد القادر على ذلك والذي ايضا لا يملكه غيري.



 وأيضا هناك إمكانيات أُخرى غير التشفير والتي سنعرفها بعد قليل,  ولنأخذ مثالاً على استخدام المفتاح العام لنتعرف عليها ولتتضح الأمور بشكل أفضل:

لدينا طرفي اتصال, الاول زيد (العميل) والثاني جوجل (الخادم), كل منهما لديه مفتاح علني وآخر سري وكل منهما سيتواصل مع الاخر ويرسل ويستقبل الرسائل المشفرة, ولنرى جميع الحالات التي يمكن أن تستخدم بها هذه المفاتيح:

1.  اذا أراد زيد أن يرسل رسالة مشفرة الى الخادم: سيقوم باستخدام المفتاح العلني الخاص بالخادم لتشفير الرسالة ثم ارسالها له. هذه الرسالة لا يمكن فك تشفيرها الا باستخدام المفتاح الآخر والذي لا يملكه إلا الخادم. فلو اعترض أي احد الرسالة فلن يستطيع فكها. 
2. اذا اراد الخادم ارسال رسالة مشفرة الى زيد: نفس الحالة السابقة, سيستخدم الخادم المفتاح العلني الخاص بزيد ويرسلها له.
3. اذا اراد الخادم أن يثبت هويته لزيد, أي أنه هو فعلا خادم جوجل وليس شخص آخر يدعي ذلك: يمكن أن يقوم الخادم بارسال رسالة مشفرة باستخدام مفتاحه السري, هذه الرسالة يمكن لأي احد أن يفك تشفيرها وذلك لان المفتاح العلني متاح للجميع, لكن اذا تم فك تشفيرها فعلاً بالمفتاح العلني الخاص بجوجل فذلك يؤكد أن من ارسل الرسالة هو خادم جوجل نفسه وليس شخص آخر. وهذه هي الميزة الاضافية التي تتيحها طريقة التشفير بالمفاتح العام, وهي اثبات الهوية.
4. إذا أراد زيد أن يثبت هويته للخادم الذي يتواصل معه: نفس الحالة السابقة, سيقوم زيد بتشفير الرسالة باستخدام مفتاحه السري وارسالها للخادم. فان استطاع الخادم فك تشفيرها بمفتاح زيد العنلي, ذلك يثبت أن زيد هو من شفر الرسالة وذلك لأنه هو الوحيد الذي يملك المفتاح الاخر.
5. يمكن دمج استخدام المفتاح السري والعلني لتحقيق الميزتين: التشفير وتأكيد الهوية. فلو قام زيد بتشفير الرسالة باستخدام مفتاحه الرسي(اثبات الهوية) ثم قام بتشفيرها ايضاً بالمفتاح العلني الخاص بخادم جوجل(تشفير), فبذلك سيرسل زيد رسالة مشفرة ويثبت في نفس الوقت أنه هو من ارسلها وليس شخصاً آخر قام بارسالها.

الاستخدام الإضافي للمفتاح العلني باثبات الهوية له تطبيقات عدة أهمها يدخل في التوقيع الالكتروني (Digital Signature).



#### الإستيثاق:

**هي عملية التأكد من هوية الطرف الآخر والتحقق من موثوقيته.** 



التأكد من الهوية يتم بخطوتين:

1. يقوم الطرف الذي يريد اثبات هويته -الخادم مثلاً- بارسال شهادة توثيقه(Cirtificate) الى الطرف الآخر -العميل مثلاً-.
2. يقوم الطرف الاخر -العميل- بالتحقق من شهادة التوثيق وصلاحيتها.



بعد أن تأكدنا من هوية الطرف الآخر يجب أن نعلم هل هو موثوق أم لا. يكون الطرف الآخر تكون اما بكونه في قائمة من أثق بهم مباشرة أو أنه موثوق لدى طرف آخرٍ انا أثق به. وهذا ما يعرف بسلسلة الثقة. أي أني أثق بمن هو موثوقٌ عند من أثق بهم.

 

#### سلامة البيانات:

**هي آلية لكشف العبث والتزوير في البيانات والتأكد من سلامتها**. وذلك من خلال ارسال شيفرة توثيقي للرسالة Message Authentication Code (MAC). وهو لابد(Hash) يتم توليده لكل سجل TLS يتم ارساله. حيث يقوم الطرف الآخر باعادة توليد اللابد للتاكد من سلامة الرسالة المستلمة.



تم تصميم بروتوكول أمن طبقة النقل الـ TLS حيثُ يأتي بين طبقة التطبيق وطبقة النقل وبذلك فان بروتوكولات طبقة النقل لا تتأثر بالتشفير وبما يفعله الـ TLS فهو أمر لا يعنيها. لذلك فإن لدينا بروتوكول HTTPS وليس لدينا TLSS أو UDPS على سبيل المثال.



![TLS-Handshake](/home/hartha/Desktop/TLS-Handshake.svg)





سنتحدث باذن الله عن بروتوكول أمن النقل ببعض التفصيل, ونشمل:

1. التصافح (Handshake).
2. استئناف الجلسة (Session Resumption).
3. سلسلة الثقة (Chain of Trust) ومراجع التصديق (Certificate Authorities).
4. تحسين أداء الـ TLS.



### تصافح الـ TLS 

قبل فتح قناة اتصال آمنة بين طرفين, يجب أولاً أن يتفقا على عدّة أُمورٍ بينهما, وهذا دائماً هدف التصافح, وهو التهئية والإعداد للإتصال. الا أن هذا مختلف قليلاً في تصافح الـ TLS, فأغلب الأُمور المهمة تتم خلال التصافح. فيجب على الطرفين الاتفاق على إصدار الـ TLS وخوارزمية التشفير (ciphersuite) وعلى المفاتيح التي ستستخدم في التشفير. وأيضاً يعطي بروتوكول الـ TLS لكلا طرفي الاتصال إمكانية التحقق من هويّة الآخر(الإستيثاق) كجزء من عملية التصافح. للأسف فكل واحدةٍ مما سبق تتطلب جولة كاملة(Round Trip), وهذا يزيد زمن الوصول لكل الإتصالات التي تستخدم الـ TLS.



![تصافح-بروتوكول-أمن-النقل](/home/hartha/Desktop/تصافح-بروتوكول-أمن-النقل.svg)

**0 ج.ث:**

 يعمل بروتكول الـ TLS فوق بروتوكول النقل TCP, لذا فيجب في البداية اكمال التصافح الثلاثي الخاص بالـTCP. والذي ياخذ دورة كاملة.



**56 ج.ث:**

يرسل العميل اول رسالة تخص تصافح الـTLS وتدعى ب "ترحيب العميل" (Client Hello) وتتضمن قائمة باصدارات الـ TLS التي يدعهما, وقائمة أٌخرى بحزم التشفير(Ciphersuite) المدعومة وغيرها. 



**84 ج.ث:**

يقوم الخادم باختيار اصدار الـTLS وحزمة التشفير التي يرغب بها من القوائم التي ارسلها العميل ومن ثم يرفق شهادة توثيقه(Certificate) ويرسل الرد الى العميل. إختيارياً, يمكن للخادم طلب شهادة توثيقٍ من العميل ومعاملات أُخرى تخص اضافات ما للTLS.



**112 ج.ث:**

على فرض أن كلا الطرفين استطاعا التوفيق فيما بينهما بخصوص الإصدار وحزمة التشفير, وأن العميل قَبِلَ الشهادة التي ارسلها الخادم, عندها سيبدأ العميل بتهيئة مفتاح التشفير المتناظر(Symmetric Key) باستخدام خوارزمية ديفي-هيلمن أو خوارزيمة RSA, وهذا يعرف بعملية تبادل المفتاح (Key Exchange).



**140 ج.ث:**

يقوم الخادم  بمعالجة المعاملات الخاصة بعملية تبادل المفتاح المتناظر والتأكد من سلامة الرسالة من خلال التحقق من لابد الرسالة (MAC). ثم يرسل رسالة إنهاء (Finish Message) مشفرة الى العميل.



**168 ج.ث**:

يقوم العميل بفك شيفرة الرسالة بستخدام المفتاح المتناظر ثم التأكد من سلامة الرسالة من خلال لابد الرسالة (MAC). فاذا مر على كل شيءٍ على ما يرام, عندها تكون قناة الـTLS جاهزة ويمكن البدء بتبادل بيانات التطبيق.



كما يتضح, يحتاج الـ TLS الى جولتين كاملتين لإتمام التصافح! هذا يعني أن كافة الاتصالات الآمنة التي تستخدم الـTLS ستسبق بجولتين كاملتين قبل بدء الاتصال الفعلي! وهذا أمر سيء جداً, لكن لحسن الحظ فإن لدينا تحسينات على عملية التصافح تضمن تقليص الجولتين الى جولة واحدة(RTT-1) فقط:



##### البداية الكاذبة (False Start): 

هي إضافة TLS تسمح لطرفي الاتصال ببدء ارسال بيانات التطبيق قبل إنتهاء علمية التصافح, وذلك بعد أن يرسل الخادم رسالة الإنهاء. وبذلك تقلص الجولتين الى جولة واحدة.



##### استئناف الجلسة (Session Resumption):

اذا كان هناك اتصال سابق بين الخادم والعميل عندها يمكن استخدام المفتاح المتناظر القديم والمتبادل مسبقاً دون الحاجة الى تكرار عملية توليده وتبادله, وهذا أيضاً يقلص عدد الجولات الى جولة واحدة.



هذان التحسينان يضمنان تقليص الجولتين الى جولة واحدة للاتصالات الجديدة والمتكررة في اصدار TLS 1.2. أما في اصدار TLS 1.3 فقد تم تحسين التصميم بحيث لا يستهلك تهيئة TLS للاتصالات المتكررة أي جولة عملياً. أي 0-RTT.



نستنتج أن تصافح الـTLS غرضه تهيئه الطرفين لبدء تشفير وتأمين الاتصال. فيتم فيه:

1.  الاتفاق على تفاصيل التشفير: الاصدار, حزمة التشفير ومعاملات أُخرى تخص اضافات على الـTLS.
2.  توليد وتبادل مفاتيح التشفير.
3. استيثاق طرفي الاتصال من بعضهمها. خاصة ان يستوثق العميل من هوية الخادم.



#### حزمة التشفير (Cipher Suite)

5. اذا أراد العميل 

### سلسلة الثقة ومراجع التصديق (Chain of Trust and Certificate Authorities):



















